{% extends "index.html" %}
{% load static %}

{% block contenido %}

<main class="retro-dashboard">

    <h2 class="retro-title-large">Hola, {{ user.username }}</h2>

    {% if es_jefe %}
    <section class="retro-section">
        <p class="retro-info">Eres Jefe de Operadores. Tienes acceso total.</p>

        <div class="retro-actions">
            <a class="retro-btn retro-btn-small" href="{% url 'fx_crear' 'INSTITUCIONAL' %}">
                Crear FX institucional
            </a>
            <a class="retro-btn retro-btn-small" href="{% url 'fx_crear' 'OPERADOR' %}">
                Crear FX propio
            </a>

            <a class="retro-btn retro-btn-small" href="{% url 'programa_crear' %}">
                Crear Programa
            </a>
        </div>
    </section>
    {% endif %}

    <!-- FX INSTITUCIONALES -->
    <section class="retro-section">
        <h3 class="retro-subtitle">FX institucionales</h3>

        <div class="retro-fx-grid">
            {% for fx in fx_institucionales %}
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="retro-fx-btn" data-color="{{ fx.color_boton|default:'#E76219' }}"
                    data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
                    onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1')); this.style.backgroundColor = this.dataset.color;">
                    {{ fx.nombre }}
                </button>
                <a class="retro-link" href="{% url 'fx_editar' fx.id %}"
                    style="display: flex; justify-content: center; align-items: center; width: fit-content; margin: auto;"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#FDDCA9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                        <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                    </svg></a>
            </div>
            {% empty %}
            <p class="retro-empty">No hay FX institucionales.</p>
            {% endfor %}
        </div>
    </section>

    <!-- FX PROPIOS -->
    <section class="retro-section">
        <h3 class="retro-subtitle">Mis FX propios</h3>

        <div class="retro-fx-grid">
            {% for fx in fx_propios %}
            <div class="retro-fx-item" style="display: flex; align-items: center;">
                <button class="retro-fx-btn" data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
                    onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1'))" style="width: 100%;">
                    {{ fx.nombre }}
                </button>
                <a class="retro-link" href="{% url 'fx_editar' fx.id %}"
                    style="display: flex; align-items: center; justify-content: center; width: fit-content;"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="#FDDCA9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                        <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                    </svg></a>
            </div>
            {% empty %}
            <p class="retro-empty">Aún no tienes FX propios.</p>
            {% endfor %}
        </div>
    </section>
    <section class="retro-section">
        <h3 class="retro-subtitle">
            {% if es_jefe %}
            Programas
            {% else %}
            Programas asignados
            {% endif %}
        </h3>

        <ul class="retro-program-list" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 30px;">
    {% for p in programas %}
    <li style="display: flex; flex-direction: column; gap: 5px;">
        <a class="retro-link" href="{% url 'programa_detalle' p.id %}">
            {{ p.nombre }}
        </a>
        {% if es_jefe %}
        <a class="retro-btn retro-btn-small" href="{% url 'programa_editar' p.id %}">
            Editar
        </a>
        {% endif %}
    </li>
    {% empty %}
    <li class="retro-empty">
        {% if es_jefe %}
        No hay programas creados.
        {% else %}
        No tienes programas asignados.
        {% endif %}
    </li>
    {% endfor %}
</ul>

    </section>


</main>

<script>
    let currentAudio = null;

    function playFx(url, volume = 1.0) {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
        }
        currentAudio = new Audio(url);
        currentAudio.volume = Math.max(0, Math.min(1, volume));
        currentAudio.play();
    }
</script>

<script>
    function getLuminance(hex) {
        // Eliminar el #
        hex = hex.replace("#", "");

        // Convertir a RGB
        let r = parseInt(hex.substr(0, 2), 16);
        let g = parseInt(hex.substr(2, 2), 16);
        let b = parseInt(hex.substr(4, 2), 16);

        // Calcular luminancia relativa (WCAG)
        let a = [r, g, b].map(v => {
            v /= 255;
            return v <= 0.03928
                ? v / 12.92
                : Math.pow((v + 0.055) / 1.055, 2.4);
        });

        return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".retro-fx-btn").forEach(btn => {
            let bg = btn.style.backgroundColor;

            // Convertir rgb() → hex si es necesario
            if (bg.startsWith("rgb")) {
                const rgb = bg.match(/\d+/g).map(Number);
                bg = "#" + rgb.map(v => v.toString(16).padStart(2, "0")).join("");
            }

            // Si sigue sin ser hex, no hacemos nada
            if (!bg.startsWith("#")) return;

            const luminance = getLuminance(bg);

            // Si la luminancia es baja, el color es oscuro → poner texto blanco
            if (luminance < 0.5) {
                btn.style.color = "white";
            } else {
                btn.style.color = "black";
            }
        });
    });
</script>


{% endblock %}