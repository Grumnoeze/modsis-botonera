{% extends "index.html" %}
{% load static %}

{% block contenido %}

<main class="retro-dashboard">

    <h2 class="retro-title-large">Hola, {{ user.username }}</h2>

    {% if es_jefe %}
    <section class="retro-section">
        <p class="retro-info">Eres Jefe de Operadores. Tienes acceso total.</p>

        <div class="retro-actions">
            <a class="retro-btn retro-btn-small" href="{% url 'fx_crear' 'INSTITUCIONAL' %}?next={{ request.path }}">
                Crear FX institucional
            </a>
            <a class="retro-btn retro-btn-small" href="{% url 'fx_crear' 'OPERADOR' %}">
                Crear FX propio
            </a>

            <a class="retro-btn retro-btn-small" href="{% url 'programa_crear' %}">
                Crear Programa
            </a>
        </div>
    </section>
    {% endif %}

    <!-- FX INSTITUCIONALES -->
    <section class="retro-section">
        <h3 class="retro-subtitle">FX institucionales</h3>

        <div class="retro-fx-grid">
            {% for fx in fx_institucionales %}
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="retro-fx-btn" data-color="{{ fx.color_boton|default:'#E76219' }}"
                    data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
                    onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1')); this.style.backgroundColor = this.dataset.color;">
                    {{ fx.nombre }}
                </button>
                {% if perfil.rol == 'JEFE' %}
                <div style="display: flex;">
                    <a class="retro-link" href="{% url 'fx_editar' fx.id %}"
                        style="display: flex; justify-content: center; align-items: center; width: fit-content; margin: auto;"><svg
                            xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="#FDDCA9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                            <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                        </svg></a>
                    <a class="retro-link" href="{% url 'fx_eliminar' fx.id %}"
                        style="display: flex; justify-content: center; align-items: center; width: fit-content; margin: auto;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#FDDCA9"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <p class="retro-empty">No hay FX institucionales.</p>
            {% endfor %}
        </div>
    </section>

    <!-- FX PROPIOS -->
    <section class="retro-section">
        <h3 class="retro-subtitle">Mis FX propios</h3>

        <div class="retro-fx-grid">
            {% for fx in fx_propios %}
            <div class="retro-fx-item" style="display: flex; align-items: center;">
                <button class="retro-fx-btn" data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
                    onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1'))" style="width: 100%;">
                    {{ fx.nombre }}
                </button>
                <div style="display: flex; flex-direction: row;">
                    <a class="retro-link" href="{% url 'fx_editar' fx.id %}"
                        style="display: flex; align-items: center; justify-content: center; width: fit-content;"><svg
                            xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="#FDDCA9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                            <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                        </svg>
                    </a>
                    <a class="retro-link" href="{% url 'fx_eliminar' fx.id %}"
                        style="display: flex; align-items: center; justify-content: center; width: fit-content;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#FDDCA9"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </a>
                </div>
            </div>
            {% empty %}
            <p class="retro-empty">Aún no tienes FX propios.</p>
            {% endfor %}
        </div>
    </section>
    <section class="retro-section">
        <h3 class="retro-subtitle">
            {% if es_jefe %}
            Programas
            {% else %}
            Programas asignados
            {% endif %}
        </h3>

        <ul class="retro-program-list" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 30px;">
            {% for p in programas %}
            <li style="display: flex; flex-direction: column;">
                <a class="retro-link" href="{% url 'programa_detalle' p.id %}">
                    {{ p.nombre }}
                </a>
                {% if es_jefe %}
                <div style="display: flex; justify-content: space-between;">
                    <a class="retro-btn retro-btn-small" href="{% url 'programa_editar' p.id %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path>
                            <polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon>
                        </svg>
                    </a>
                    <a class="retro-btn retro-btn-small" href="{% url 'programa_eliminar' p.id %}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#FFFFFF"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </li>
            {% empty %}
            <li class="retro-empty">
                {% if es_jefe %}
                No hay programas creados.
                {% else %}
                No tienes programas asignados.
                {% endif %}
            </li>
            {% endfor %}
        </ul>

    </section>

    <script>
        let currentAudio = null;
        function playFx(url, volume = 1.0) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            currentAudio = new Audio(url);

            // Forzar que siempre haya al menos 0.1 de volumen
            let safeVolume = Math.max(0.1, Math.min(1, volume));
            currentAudio.volume = safeVolume;

            currentAudio.play();
        }

        // Función para calcular luminancia y decidir color de texto
        function getLuminance(hex) {
            hex = hex.replace("#", "");
            let r = parseInt(hex.substr(0, 2), 16);
            let g = parseInt(hex.substr(2, 2), 16);
            let b = parseInt(hex.substr(4, 2), 16);

            let a = [r, g, b].map(v => {
                v /= 255;
                return v <= 0.03928
                    ? v / 12.92
                    : Math.pow((v + 0.055) / 1.055, 2.4);
            });

            return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".retro-fx-btn").forEach(btn => {
                // aplicar el color guardado
                if (btn.dataset.color) {
                    btn.style.backgroundColor = btn.dataset.color;

                    // ajustar color de texto según luminancia
                    const luminance = getLuminance(btn.dataset.color);
                    btn.style.color = luminance < 0.5 ? "white" : "black";
                }
            });
        });
    </script>



</main>



{% endblock %}