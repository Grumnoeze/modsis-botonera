{% extends "index.html" %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Programa: {{ programa.nombre }}</title>
</head>

<body>
  {% block contenido %}
  <style>
    :root {
      --retro-dark: #562717;
      --retro-red: #C21717;
      --retro-orange: #E76219;
      --retro-yellow: #FEA712;
      --retro-beige: #FDDCA9;
    }

    body {
      font-family: 'Courier New', monospace;
      background: var(--retro-dark);
      margin: 0;
      color: var(--retro-beige);
    }

    header{
      margin-bottom: 25px;
    }

    .retro-container {
      max-width: 900px;
      margin: auto;
      background: var(--retro-beige);
      padding: 20px;
      border: 4px solid var(--retro-red);
      border-radius: 6px;
      color: #000;
      box-shadow: 0 0 15px #00000055;
    }

    h2 {
      background: var(--retro-red);
      color: white;
      padding: 10px;
      border: 2px solid black;
      border-radius: 4px;
      margin-top: 0;
      text-align: center;
    }

    .program-desc {
      background: #ffffffcc;
      padding: 15px;
      border-left: 4px solid var(--retro-orange);
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 15px;
    }

    /* Secciones retro */
    .retro-section {
      margin-top: 25px;
      background: #fff6e3;
      border: 3px solid var(--retro-dark);
      border-radius: 6px;
      padding: 15px;
    }

    .retro-subtitle {
      margin-top: 0;
      padding: 8px;
      padding-bottom: 0;
      margin-bottom: 0 !important;
      background: var(--retro-orange);
      border-radius: 4px;
      border: 2px solid black;
      color: #FFF;
    }

    /* Grid de botones FX */
    .retro-fx-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .retro-fx-btn {
      border: 2px solid black;
      padding: 10px;
      cursor: pointer;
      font-family: inherit;
      border-radius: 4px;
      font-weight: bold;
      transition: 0.2s;
      color: black;
    }

    .retro-fx-btn:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }

    /* Botones pequeños */
    .retro-btn-small {
      font-size: 14px;
      padding: 6px 10px;
      display: inline-block;
      margin-bottom: 15px;
      border: 2px solid black;
      border-radius: 4px;
      text-decoration: none;
      background: var(--retro-red);
      color: white;
    }

    .retro-btn-small:hover {
      background: var(--retro-orange);
      color: black;
    }

    /* Listas de operadores/productores */
    .retro-list {
      background: #fff6e3;
      border: 2px solid var(--retro-dark);
      padding: 10px 15px;
      border-radius: 6px;
      list-style: square;
      color: black;
      margin-bottom: 10px;
    }

    .retro-empty {
      color: #555;
      font-style: italic;
    }
  </style>
  <div class="retro-container">

    <h2>{{ programa.nombre }}</h2>

    <div class="program-desc">
      {{ programa.descripcion }}
    </div>

    {% if es_jefe or user in programa.operadores.all %}
    <a class="retro-btn-small" href="{% url 'fx_crear_programa' 'PROGRAMA' programa.id %}">
      ➤ Crear FX de este programa
    </a>
    {% endif %}

    <!-- FX institucionales -->
    <section class="retro-section">
      <h3 class="retro-subtitle">FX institucionales</h3>
      <div class="retro-fx-grid">
        {% for fx in fx_institucionales %}
        <button class="retro-fx-btn" style="background-color: {{ fx.color_boton|default:'#E76219' }};"
          data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
          onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1'))">
          {{ fx.nombre }}
        </button>
        {% empty %}
        <p class="retro-empty">No hay FX institucionales.</p>
        {% endfor %}
      </div>
    </section>

    <!-- FX del programa -->
    <section class="retro-section" style="margin-bottom: 15px;">
      <h3 class="retro-subtitle">FX del programa</h3>
      <div class="retro-fx-grid">
        {% for fx in fx_programa %}

        <div>
          <button class="retro-fx-btn" style="background-color: {{ fx.color_boton|default:'#E76219' }};"
            data-file-url="{{ fx.archivo.url }}" data-volume="{{ fx.volumen_default }}"
            onclick="playFx(this.dataset.fileUrl, parseFloat(this.dataset.volume || '1'))">
            {{ fx.nombre }}
          </button>

          {% if es_jefe or user in programa.operadores.all %}
          <a href="{% url 'fx_editar' fx.id %}" class="retro-btn-small" style="margin-top:5px; display:block;">
            Editar FX
          </a>
          {% endif %}
        </div>

        {% empty %}
        <p class="retro-empty">No hay FX asignados a este programa.</p>
        {% endfor %}
      </div>
    </section>

    <!-- Operadores -->
    <h3 class="retro-subtitle">Operadores asignados</h3>
    <ul class="retro-list">
      {% for op in operadores %}
      <li>{{ op.username }}</li>
      {% empty %}
      <li class="retro-empty">No hay operadores asignados.</li>
      {% endfor %}
    </ul>

    <!-- Productores -->
    <h3 class="retro-subtitle">Productores asignados</h3>
    <ul class="retro-list">
      {% for prod in productores %}
      <li>{{ prod.username }}</li>
      {% empty %}
      <li class="retro-empty">No hay productores asignados.</li>
      {% endfor %}
    </ul>
  </div>

  <script>
    let currentAudio = null;
    function playFx(url, volume = 1.0) {
      if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
      currentAudio = new Audio(url);
      currentAudio.volume = Math.max(0, Math.min(1, volume));
      currentAudio.play();
    }
  </script>

<script>
    function getLuminance(hex) {
        // Eliminar el #
        hex = hex.replace("#", "");

        // Convertir a RGB
        let r = parseInt(hex.substr(0, 2), 16);
        let g = parseInt(hex.substr(2, 2), 16);
        let b = parseInt(hex.substr(4, 2), 16);

        // Calcular luminancia relativa (WCAG)
        let a = [r, g, b].map(v => {
            v /= 255;
            return v <= 0.03928
                ? v / 12.92
                : Math.pow((v + 0.055) / 1.055, 2.4);
        });

        return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".retro-fx-btn").forEach(btn => {
            let bg = btn.style.backgroundColor;

            // Convertir rgb() → hex si es necesario
            if (bg.startsWith("rgb")) {
                const rgb = bg.match(/\d+/g).map(Number);
                bg = "#" + rgb.map(v => v.toString(16).padStart(2, "0")).join("");
            }

            // Si sigue sin ser hex, no hacemos nada
            if (!bg.startsWith("#")) return;

            const luminance = getLuminance(bg);

            // Si la luminancia es baja, el color es oscuro → poner texto blanco
            if (luminance < 0.5) {
                btn.style.color = "white";
            } else {
                btn.style.color = "black";
            }
        });
    });
</script>
{% endblock %}
</body>

</html>
